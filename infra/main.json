{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "14483501337651981772"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "baseName": {
      "type": "string",
      "defaultValue": "voicejournal",
      "minLength": 3,
      "maxLength": 20,
      "metadata": {
        "description": "Base name for all resources"
      }
    },
    "openAiChatModelName": {
      "type": "string",
      "defaultValue": "gpt-4o",
      "metadata": {
        "description": "Azure OpenAI model deployment name for GPT-4o"
      }
    },
    "openAiWhisperModelName": {
      "type": "string",
      "defaultValue": "whisper",
      "metadata": {
        "description": "Azure OpenAI model deployment name for Whisper"
      }
    },
    "apiContainerImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Container image for the API"
      }
    },
    "uiContainerImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Container image for the UI"
      }
    },
    "workerContainerImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Container image for the Worker"
      }
    },
    "postgresAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "PostgreSQL administrator password"
      }
    },
    "enablePrivateEndpoints": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable private endpoint connectivity (disables public access to backend services)"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "application": "voice-journal",
        "environment": "[parameters('environment')]",
        "managedBy": "bicep"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    }
  },
  "variables": {
    "resourcePrefix": "[format('{0}-{1}', parameters('baseName'), parameters('environment'))]",
    "resourcePrefixNoDash": "[replace(variables('resourcePrefix'), '-', '')]"
  },
  "resources": [
    {
      "condition": "[parameters('enablePrivateEndpoints')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6092389764798066839"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource naming prefix"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.0.0/16",
              "metadata": {
                "description": "VNet address space"
              }
            },
            "containerAppsSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.0.0/23",
              "metadata": {
                "description": "Container Apps subnet address prefix (minimum /23 required)"
              }
            },
            "privateEndpointsSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.2.0/24",
              "metadata": {
                "description": "Private endpoints subnet address prefix"
              }
            }
          },
          "variables": {
            "vnetName": "[format('vnet-{0}', parameters('resourcePrefix'))]",
            "containerAppsSubnetName": "snet-container-apps",
            "privateEndpointsSubnetName": "snet-private-endpoints",
            "containerAppsNsgName": "[format('nsg-{0}-container-apps', parameters('resourcePrefix'))]",
            "privateEndpointsNsgName": "[format('nsg-{0}-private-endpoints', parameters('resourcePrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[variables('containerAppsNsgName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowHTTPS",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "443"
                    }
                  },
                  {
                    "name": "AllowHTTP",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "80"
                    }
                  }
                ]
              },
              "metadata": {
                "description": "NSG for Container Apps subnet"
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[variables('privateEndpointsNsgName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": []
              },
              "metadata": {
                "description": "NSG for Private Endpoints subnet"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-01-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[variables('containerAppsSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('containerAppsSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('containerAppsNsgName'))]"
                      },
                      "delegations": [
                        {
                          "name": "Microsoft.App.environments",
                          "properties": {
                            "serviceName": "Microsoft.App/environments"
                          }
                        }
                      ],
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "[variables('privateEndpointsSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('privateEndpointsSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('privateEndpointsNsgName'))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('containerAppsNsgName'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('privateEndpointsNsgName'))]"
              ],
              "metadata": {
                "description": "Virtual Network for Voice Journal application"
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Virtual Network resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Virtual Network name"
              },
              "value": "[variables('vnetName')]"
            },
            "containerAppsSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[0].id]"
            },
            "containerAppsSubnetName": {
              "type": "string",
              "metadata": {
                "description": "Container Apps subnet name"
              },
              "value": "[variables('containerAppsSubnetName')]"
            },
            "privateEndpointsSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private Endpoints subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[1].id]"
            },
            "privateEndpointsSubnetName": {
              "type": "string",
              "metadata": {
                "description": "Private Endpoints subnet name"
              },
              "value": "[variables('privateEndpointsSubnetName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "security-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3811489462389887556"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource naming prefix"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "variables": {
            "keyVaultName": "[replace(format('kv-{0}', parameters('resourcePrefix')), '-', '')]",
            "keyVaultSecretsUserRoleId": "4633458b-17de-408a-b874-0445c86b69e6"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[format('id-{0}-api', parameters('resourcePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "metadata": {
                "description": "Managed identity for the API container app"
              }
            },
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[format('id-{0}-ui', parameters('resourcePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "metadata": {
                "description": "Managed identity for the UI container app"
              }
            },
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[format('id-{0}-worker', parameters('resourcePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "metadata": {
                "description": "Managed identity for the Worker container app"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "enablePurgeProtection": true,
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              },
              "metadata": {
                "description": "Azure Key Vault for storing secrets"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-api', parameters('resourcePrefix'))), variables('keyVaultSecretsUserRoleId'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-api', parameters('resourcePrefix'))), '2023-01-31').principalId]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsUserRoleId'))]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-api', parameters('resourcePrefix')))]",
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ],
              "metadata": {
                "description": "API identity can read secrets from Key Vault"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-worker', parameters('resourcePrefix'))), variables('keyVaultSecretsUserRoleId'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-worker', parameters('resourcePrefix'))), '2023-01-31').principalId]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsUserRoleId'))]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-worker', parameters('resourcePrefix')))]"
              ],
              "metadata": {
                "description": "Worker identity can read secrets from Key Vault"
              }
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              },
              "value": "[variables('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "URI of the Key Vault"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri]"
            },
            "apiIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the API managed identity"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-api', parameters('resourcePrefix')))]"
            },
            "apiIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the API managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-api', parameters('resourcePrefix'))), '2023-01-31').principalId]"
            },
            "apiIdentityClientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID of the API managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-api', parameters('resourcePrefix'))), '2023-01-31').clientId]"
            },
            "uiIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the UI managed identity"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-ui', parameters('resourcePrefix')))]"
            },
            "uiIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the UI managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-ui', parameters('resourcePrefix'))), '2023-01-31').principalId]"
            },
            "workerIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Worker managed identity"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-worker', parameters('resourcePrefix')))]"
            },
            "workerIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the Worker managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-worker', parameters('resourcePrefix'))), '2023-01-31').principalId]"
            },
            "workerIdentityClientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID of the Worker managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-worker', parameters('resourcePrefix'))), '2023-01-31').clientId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "data-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "resourcePrefixNoDash": {
            "value": "[variables('resourcePrefixNoDash')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "apiIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.apiIdentityPrincipalId.value]"
          },
          "workerIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.workerIdentityPrincipalId.value]"
          },
          "postgresAdminPassword": {
            "value": "[parameters('postgresAdminPassword')]"
          },
          "enablePrivateEndpoints": {
            "value": "[parameters('enablePrivateEndpoints')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16171027044137844764"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource naming prefix"
              }
            },
            "resourcePrefixNoDash": {
              "type": "string",
              "metadata": {
                "description": "Resource naming prefix without dashes (for storage account)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault for storing connection strings"
              }
            },
            "apiIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the API managed identity"
              }
            },
            "workerIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the Worker managed identity"
              }
            },
            "postgresAdminLogin": {
              "type": "string",
              "defaultValue": "pgadmin",
              "minLength": 1,
              "metadata": {
                "description": "PostgreSQL administrator login name"
              }
            },
            "postgresAdminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "PostgreSQL administrator password"
              }
            },
            "postgresVersion": {
              "type": "string",
              "defaultValue": "16",
              "allowedValues": [
                "16",
                "15",
                "14",
                "13",
                "12"
              ],
              "metadata": {
                "description": "PostgreSQL version"
              }
            },
            "postgresSku": {
              "type": "string",
              "defaultValue": "Standard_B1ms",
              "metadata": {
                "description": "PostgreSQL SKU name (compute size)"
              }
            },
            "postgresSkuTier": {
              "type": "string",
              "defaultValue": "Burstable",
              "allowedValues": [
                "Burstable",
                "GeneralPurpose",
                "MemoryOptimized"
              ],
              "metadata": {
                "description": "PostgreSQL SKU tier"
              }
            },
            "postgresStorageSizeGB": {
              "type": "int",
              "defaultValue": 32,
              "minValue": 32,
              "maxValue": 16384,
              "metadata": {
                "description": "PostgreSQL storage size in GB"
              }
            },
            "enablePrivateEndpoints": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable private endpoint connectivity (disables public access)"
              }
            }
          },
          "variables": {
            "postgresServerName": "[format('psql-{0}', parameters('resourcePrefix'))]",
            "postgresDatabaseName": "voicejournal",
            "storageAccountName": "[take(format('st{0}data', parameters('resourcePrefixNoDash')), 24)]",
            "audioBlobContainerName": "audio-files",
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe"
          },
          "resources": [
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2024-08-01",
              "name": "[variables('postgresServerName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('postgresSku')]",
                "tier": "[parameters('postgresSkuTier')]"
              },
              "properties": {
                "version": "[parameters('postgresVersion')]",
                "administratorLogin": "[parameters('postgresAdminLogin')]",
                "administratorLoginPassword": "[parameters('postgresAdminPassword')]",
                "storage": {
                  "storageSizeGB": "[parameters('postgresStorageSizeGB')]",
                  "autoGrow": "Enabled"
                },
                "backup": {
                  "backupRetentionDays": 7,
                  "geoRedundantBackup": "Disabled"
                },
                "highAvailability": {
                  "mode": "Disabled"
                },
                "network": {
                  "publicNetworkAccess": "[if(parameters('enablePrivateEndpoints'), 'Disabled', 'Enabled')]"
                },
                "authConfig": {
                  "activeDirectoryAuth": "Disabled",
                  "passwordAuth": "Enabled"
                }
              },
              "metadata": {
                "description": "Azure PostgreSQL Flexible Server for storing journal entries"
              }
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
              "apiVersion": "2024-08-01",
              "name": "[format('{0}/{1}', variables('postgresServerName'), variables('postgresDatabaseName'))]",
              "properties": {
                "charset": "UTF8",
                "collation": "en_US.utf8"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
              ],
              "metadata": {
                "description": "PostgreSQL database for voice journal"
              }
            },
            {
              "condition": "[not(parameters('enablePrivateEndpoints'))]",
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/firewallRules",
              "apiVersion": "2024-08-01",
              "name": "[format('{0}/{1}', variables('postgresServerName'), 'AllowAzureServices')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
              ],
              "metadata": {
                "description": "Allow Azure services to access PostgreSQL (only when not using private endpoints)"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": "[not(parameters('enablePrivateEndpoints'))]",
                "publicNetworkAccess": "[if(parameters('enablePrivateEndpoints'), 'Disabled', 'Enabled')]",
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "networkAcls": {
                  "defaultAction": "[if(parameters('enablePrivateEndpoints'), 'Deny', 'Allow')]",
                  "bypass": "AzureServices"
                }
              },
              "metadata": {
                "description": "Azure Storage account for audio files"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "properties": {
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ],
              "metadata": {
                "description": "Blob service for storage account"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', variables('audioBlobContainerName'))]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ],
              "metadata": {
                "description": "Blob container for audio files"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), parameters('apiIdentityPrincipalId'), variables('storageBlobDataContributorRoleId'))]",
              "properties": {
                "principalId": "[parameters('apiIdentityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ],
              "metadata": {
                "description": "API identity has Storage Blob Data Contributor access"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), parameters('workerIdentityPrincipalId'), variables('storageBlobDataContributorRoleId'))]",
              "properties": {
                "principalId": "[parameters('workerIdentityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ],
              "metadata": {
                "description": "Worker identity has Storage Blob Data Contributor access"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'postgres-connection-string')]",
              "properties": {
                "value": "[format('postgresql://{0}:{1}@{2}:5432/{3}?sslmode=require', parameters('postgresAdminLogin'), parameters('postgresAdminPassword'), reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName')), '2024-08-01').fullyQualifiedDomainName, variables('postgresDatabaseName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
              ],
              "metadata": {
                "description": "Store PostgreSQL connection string in Key Vault"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'postgres-host')]",
              "properties": {
                "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName')), '2024-08-01').fullyQualifiedDomainName]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
              ],
              "metadata": {
                "description": "Store PostgreSQL host in Key Vault"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'postgres-password')]",
              "properties": {
                "value": "[parameters('postgresAdminPassword')]"
              },
              "metadata": {
                "description": "Store PostgreSQL password in Key Vault"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'storage-account-name')]",
              "properties": {
                "value": "[variables('storageAccountName')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ],
              "metadata": {
                "description": "Store Storage account name in Key Vault"
              }
            }
          ],
          "outputs": {
            "postgresHost": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL server fully qualified domain name"
              },
              "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName')), '2024-08-01').fullyQualifiedDomainName]"
            },
            "postgresDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL database name"
              },
              "value": "[variables('postgresDatabaseName')]"
            },
            "postgresAdminLogin": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL admin login"
              },
              "value": "[parameters('postgresAdminLogin')]"
            },
            "postgresServerName": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL server name"
              },
              "value": "[variables('postgresServerName')]"
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              },
              "value": "[variables('storageAccountName')]"
            },
            "storageBlobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage account blob endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-05-01').primaryEndpoints.blob]"
            },
            "audioBlobContainerName": {
              "type": "string",
              "metadata": {
                "description": "Audio blob container name"
              },
              "value": "[variables('audioBlobContainerName')]"
            },
            "postgresServerId": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL server resource ID"
              },
              "value": "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
            },
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage account resource ID"
              },
              "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'security-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "ai-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "chatModelName": {
            "value": "[parameters('openAiChatModelName')]"
          },
          "whisperModelName": {
            "value": "[parameters('openAiWhisperModelName')]"
          },
          "workerIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.workerIdentityPrincipalId.value]"
          },
          "apiIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.apiIdentityPrincipalId.value]"
          },
          "enablePrivateEndpoints": {
            "value": "[parameters('enablePrivateEndpoints')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6102207896011599851"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource naming prefix"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault for storing API keys"
              }
            },
            "chatModelName": {
              "type": "string",
              "defaultValue": "gpt-4o",
              "metadata": {
                "description": "GPT model deployment name"
              }
            },
            "whisperModelName": {
              "type": "string",
              "defaultValue": "whisper",
              "metadata": {
                "description": "Whisper model deployment name"
              }
            },
            "workerIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the Worker managed identity"
              }
            },
            "apiIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the API managed identity"
              }
            },
            "enablePrivateEndpoints": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable private endpoint connectivity (disables public access)"
              }
            }
          },
          "variables": {
            "openAiAccountName": "[format('oai-{0}', parameters('resourcePrefix'))]",
            "cognitiveServicesOpenAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd"
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2024-04-01-preview",
              "name": "[variables('openAiAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "OpenAI",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[variables('openAiAccountName')]",
                "publicNetworkAccess": "[if(parameters('enablePrivateEndpoints'), 'Disabled', 'Enabled')]",
                "networkAcls": {
                  "defaultAction": "[if(parameters('enablePrivateEndpoints'), 'Deny', 'Allow')]"
                },
                "disableLocalAuth": false
              },
              "metadata": {
                "description": "Azure OpenAI service account"
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-04-01-preview",
              "name": "[format('{0}/{1}', variables('openAiAccountName'), parameters('chatModelName'))]",
              "sku": {
                "name": "GlobalStandard",
                "capacity": 10
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "gpt-4o",
                  "version": "2024-11-20"
                },
                "raiPolicyName": "Microsoft.DefaultV2",
                "versionUpgradeOption": "OnceCurrentVersionExpired"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName'))]"
              ],
              "metadata": {
                "description": "GPT-4o model deployment for chat completions and summarization"
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-04-01-preview",
              "name": "[format('{0}/{1}', variables('openAiAccountName'), parameters('whisperModelName'))]",
              "sku": {
                "name": "Standard",
                "capacity": 1
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "whisper",
                  "version": "001"
                },
                "raiPolicyName": "Microsoft.DefaultV2",
                "versionUpgradeOption": "OnceCurrentVersionExpired"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', variables('openAiAccountName'), parameters('chatModelName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName'))]"
              ],
              "metadata": {
                "description": "Whisper model deployment for audio transcription"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', variables('openAiAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName')), parameters('workerIdentityPrincipalId'), variables('cognitiveServicesOpenAIUserRoleId'), 'worker')]",
              "properties": {
                "principalId": "[parameters('workerIdentityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIUserRoleId'))]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName'))]"
              ],
              "metadata": {
                "description": "Worker identity has Cognitive Services OpenAI User access"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', variables('openAiAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName')), parameters('apiIdentityPrincipalId'), variables('cognitiveServicesOpenAIUserRoleId'), 'api')]",
              "properties": {
                "principalId": "[parameters('apiIdentityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIUserRoleId'))]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName'))]"
              ],
              "metadata": {
                "description": "API identity has Cognitive Services OpenAI User access"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'openai-endpoint')]",
              "properties": {
                "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName')), '2024-04-01-preview').endpoint]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName'))]"
              ],
              "metadata": {
                "description": "Store OpenAI endpoint in Key Vault"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'openai-api-key')]",
              "properties": {
                "value": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName')), '2024-04-01-preview').key1]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName'))]"
              ],
              "metadata": {
                "description": "Store OpenAI API key in Key Vault"
              }
            }
          ],
          "outputs": {
            "openAiEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI endpoint URL"
              },
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName')), '2024-04-01-preview').endpoint]"
            },
            "openAiAccountName": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI account name"
              },
              "value": "[variables('openAiAccountName')]"
            },
            "chatDeploymentName": {
              "type": "string",
              "metadata": {
                "description": "GPT-4o deployment name"
              },
              "value": "[parameters('chatModelName')]"
            },
            "whisperDeploymentName": {
              "type": "string",
              "metadata": {
                "description": "Whisper deployment name"
              },
              "value": "[parameters('whisperModelName')]"
            },
            "openAiId": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI resource ID"
              },
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAiAccountName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'security-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "queues-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "apiIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.apiIdentityPrincipalId.value]"
          },
          "workerIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.workerIdentityPrincipalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9985962042234996756"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource naming prefix"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "apiIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the API managed identity"
              }
            },
            "workerIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the Worker managed identity"
              }
            }
          },
          "variables": {
            "serviceBusNamespaceName": "[format('sb-{0}', parameters('resourcePrefix'))]",
            "audioProcessingQueueName": "audio-processing",
            "serviceBusDataSenderRoleId": "69a216fc-b8fb-44d8-bc22-1f3c2cd27a39",
            "serviceBusDataReceiverRoleId": "4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0"
          },
          "resources": [
            {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2022-10-01-preview",
              "name": "[variables('serviceBusNamespaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Standard"
              },
              "properties": {
                "minimumTlsVersion": "1.2",
                "publicNetworkAccess": "Enabled",
                "disableLocalAuth": false,
                "zoneRedundant": false
              },
              "metadata": {
                "description": "Azure Service Bus namespace for message queuing"
              }
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', variables('serviceBusNamespaceName'), variables('audioProcessingQueueName'))]",
              "properties": {
                "lockDuration": "PT5M",
                "maxSizeInMegabytes": 1024,
                "requiresDuplicateDetection": false,
                "requiresSession": false,
                "defaultMessageTimeToLive": "P1D",
                "deadLetteringOnMessageExpiration": true,
                "duplicateDetectionHistoryTimeWindow": "PT10M",
                "maxDeliveryCount": 5,
                "enablePartitioning": false,
                "enableExpress": false,
                "enableBatchedOperations": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName'))]"
              ],
              "metadata": {
                "description": "Queue for audio processing jobs"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ServiceBus/namespaces/{0}', variables('serviceBusNamespaceName'))]",
              "name": "[guid(resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName')), parameters('apiIdentityPrincipalId'), variables('serviceBusDataSenderRoleId'))]",
              "properties": {
                "principalId": "[parameters('apiIdentityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('serviceBusDataSenderRoleId'))]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName'))]"
              ],
              "metadata": {
                "description": "API identity can send messages to Service Bus"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ServiceBus/namespaces/{0}', variables('serviceBusNamespaceName'))]",
              "name": "[guid(resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName')), parameters('workerIdentityPrincipalId'), variables('serviceBusDataReceiverRoleId'))]",
              "properties": {
                "principalId": "[parameters('workerIdentityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('serviceBusDataReceiverRoleId'))]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName'))]"
              ],
              "metadata": {
                "description": "Worker identity can receive messages from Service Bus"
              }
            }
          ],
          "outputs": {
            "serviceBusNamespace": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace name"
              },
              "value": "[variables('serviceBusNamespaceName')]"
            },
            "serviceBusNamespaceFqdn": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace FQDN"
              },
              "value": "[format('{0}.servicebus.windows.net', variables('serviceBusNamespaceName'))]"
            },
            "queueName": {
              "type": "string",
              "metadata": {
                "description": "Audio processing queue name"
              },
              "value": "[variables('audioProcessingQueueName')]"
            },
            "serviceBusEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace endpoint"
              },
              "value": "[reference(resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName')), '2022-10-01-preview').serviceBusEndpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'security-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "containerapps-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "apiContainerImage": {
            "value": "[parameters('apiContainerImage')]"
          },
          "uiContainerImage": {
            "value": "[parameters('uiContainerImage')]"
          },
          "workerContainerImage": {
            "value": "[parameters('workerContainerImage')]"
          },
          "apiIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.apiIdentityId.value]"
          },
          "apiIdentityClientId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.apiIdentityClientId.value]"
          },
          "uiIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.uiIdentityId.value]"
          },
          "workerIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.workerIdentityId.value]"
          },
          "workerIdentityClientId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.workerIdentityClientId.value]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "postgresHost": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.postgresHost.value]"
          },
          "postgresDatabaseName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.postgresDatabaseName.value]"
          },
          "postgresAdminLogin": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.postgresAdminLogin.value]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "storageBlobEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.storageBlobEndpoint.value]"
          },
          "openAiEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'ai-deployment'), '2025-04-01').outputs.openAiEndpoint.value]"
          },
          "openAiChatDeploymentName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'ai-deployment'), '2025-04-01').outputs.chatDeploymentName.value]"
          },
          "openAiWhisperDeploymentName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'ai-deployment'), '2025-04-01').outputs.whisperDeploymentName.value]"
          },
          "serviceBusNamespace": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'queues-deployment'), '2025-04-01').outputs.serviceBusNamespace.value]"
          },
          "serviceBusQueueName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'queues-deployment'), '2025-04-01').outputs.queueName.value]"
          },
          "enableVnetIntegration": {
            "value": "[parameters('enablePrivateEndpoints')]"
          },
          "containerAppsSubnetId": "[if(parameters('enablePrivateEndpoints'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.containerAppsSubnetId.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11589696232370308828"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource naming prefix"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "apiContainerImage": {
              "type": "string",
              "metadata": {
                "description": "Container image for the API"
              }
            },
            "uiContainerImage": {
              "type": "string",
              "metadata": {
                "description": "Container image for the UI"
              }
            },
            "workerContainerImage": {
              "type": "string",
              "metadata": {
                "description": "Container image for the Worker"
              }
            },
            "apiIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the API managed identity"
              }
            },
            "apiIdentityClientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID of the API managed identity"
              }
            },
            "uiIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the UI managed identity"
              }
            },
            "workerIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Worker managed identity"
              }
            },
            "workerIdentityClientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID of the Worker managed identity"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              }
            },
            "postgresHost": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL host"
              }
            },
            "postgresDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL database name"
              }
            },
            "postgresAdminLogin": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL admin login"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              }
            },
            "storageBlobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage blob endpoint URL"
              }
            },
            "openAiEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI endpoint URL"
              }
            },
            "openAiChatDeploymentName": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI chat deployment name"
              }
            },
            "openAiWhisperDeploymentName": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI Whisper deployment name"
              }
            },
            "serviceBusNamespace": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace name"
              }
            },
            "serviceBusQueueName": {
              "type": "string",
              "metadata": {
                "description": "Service Bus queue name"
              }
            },
            "enableVnetIntegration": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable VNet integration for private endpoint connectivity"
              }
            },
            "containerAppsSubnetId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Subnet ID for Container Apps (required when enableVnetIntegration is true)"
              }
            }
          },
          "variables": {
            "containerAppsEnvName": "[format('cae-{0}', parameters('resourcePrefix'))]",
            "logAnalyticsName": "[format('log-{0}', parameters('resourcePrefix'))]",
            "apiAppName": "[format('ca-{0}-api', parameters('resourcePrefix'))]",
            "uiAppName": "[format('ca-{0}-ui', parameters('resourcePrefix'))]",
            "workerAppName": "[format('ca-{0}-worker', parameters('resourcePrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[variables('logAnalyticsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "metadata": {
                "description": "Log Analytics workspace for Container Apps monitoring"
              }
            },
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[variables('containerAppsEnvName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2023-09-01').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2023-09-01').primarySharedKey]"
                  }
                },
                "vnetConfiguration": "[if(parameters('enableVnetIntegration'), createObject('infrastructureSubnetId', parameters('containerAppsSubnetId'), 'internal', false()), null())]",
                "zoneRedundant": false,
                "workloadProfiles": [
                  {
                    "name": "Consumption",
                    "workloadProfileType": "Consumption"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
              ],
              "metadata": {
                "description": "Container Apps Environment"
              }
            },
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[variables('apiAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('apiIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName'))]",
                "workloadProfileName": "Consumption",
                "configuration": {
                  "ingress": {
                    "external": true,
                    "targetPort": 8000,
                    "transport": "auto",
                    "allowInsecure": false,
                    "corsPolicy": {
                      "allowedOrigins": [
                        "*"
                      ],
                      "allowedMethods": [
                        "GET",
                        "POST",
                        "PUT",
                        "PATCH",
                        "DELETE",
                        "OPTIONS"
                      ],
                      "allowedHeaders": [
                        "*"
                      ],
                      "allowCredentials": true
                    }
                  },
                  "registries": [],
                  "secrets": []
                },
                "template": {
                  "containers": [
                    {
                      "name": "api",
                      "image": "[parameters('apiContainerImage')]",
                      "resources": {
                        "cpu": "[json('0.5')]",
                        "memory": "1Gi"
                      },
                      "env": [
                        {
                          "name": "AZURE_CLIENT_ID",
                          "value": "[parameters('apiIdentityClientId')]"
                        },
                        {
                          "name": "POSTGRES_HOST",
                          "value": "[parameters('postgresHost')]"
                        },
                        {
                          "name": "POSTGRES_DATABASE",
                          "value": "[parameters('postgresDatabaseName')]"
                        },
                        {
                          "name": "POSTGRES_USER",
                          "value": "[parameters('postgresAdminLogin')]"
                        },
                        {
                          "name": "STORAGE_ACCOUNT_NAME",
                          "value": "[parameters('storageAccountName')]"
                        },
                        {
                          "name": "STORAGE_BLOB_ENDPOINT",
                          "value": "[parameters('storageBlobEndpoint')]"
                        },
                        {
                          "name": "SERVICE_BUS_NAMESPACE",
                          "value": "[format('{0}.servicebus.windows.net', parameters('serviceBusNamespace'))]"
                        },
                        {
                          "name": "SERVICE_BUS_QUEUE_NAME",
                          "value": "[parameters('serviceBusQueueName')]"
                        },
                        {
                          "name": "KEY_VAULT_NAME",
                          "value": "[parameters('keyVaultName')]"
                        },
                        {
                          "name": "AI_PROCESSING_MODE",
                          "value": "azure_openai"
                        }
                      ],
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/api/health",
                            "port": 8000
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 30
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/api/health",
                            "port": 8000
                          },
                          "initialDelaySeconds": 5,
                          "periodSeconds": 10
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 1,
                    "maxReplicas": 10,
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName'))]"
              ],
              "metadata": {
                "description": "API Container App - FastAPI backend"
              }
            },
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[variables('uiAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('uiIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName'))]",
                "workloadProfileName": "Consumption",
                "configuration": {
                  "ingress": {
                    "external": true,
                    "targetPort": 3000,
                    "transport": "auto",
                    "allowInsecure": false
                  },
                  "registries": [],
                  "secrets": []
                },
                "template": {
                  "containers": [
                    {
                      "name": "ui",
                      "image": "[parameters('uiContainerImage')]",
                      "resources": {
                        "cpu": "[json('0.25')]",
                        "memory": "0.5Gi"
                      },
                      "env": [
                        {
                          "name": "VITE_API_URL",
                          "value": "[format('https://{0}.{1}', variables('apiAppName'), reference(resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName')), '2024-03-01').defaultDomain)]"
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 1,
                    "maxReplicas": 5,
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]",
                "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName'))]"
              ],
              "metadata": {
                "description": "UI Container App - React frontend"
              }
            },
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[variables('workerAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('workerIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName'))]",
                "workloadProfileName": "Consumption",
                "configuration": {
                  "registries": [],
                  "secrets": []
                },
                "template": {
                  "containers": [
                    {
                      "name": "worker",
                      "image": "[parameters('workerContainerImage')]",
                      "resources": {
                        "cpu": "[json('1')]",
                        "memory": "2Gi"
                      },
                      "env": [
                        {
                          "name": "AZURE_CLIENT_ID",
                          "value": "[parameters('workerIdentityClientId')]"
                        },
                        {
                          "name": "POSTGRES_HOST",
                          "value": "[parameters('postgresHost')]"
                        },
                        {
                          "name": "POSTGRES_DATABASE",
                          "value": "[parameters('postgresDatabaseName')]"
                        },
                        {
                          "name": "POSTGRES_USER",
                          "value": "[parameters('postgresAdminLogin')]"
                        },
                        {
                          "name": "STORAGE_ACCOUNT_NAME",
                          "value": "[parameters('storageAccountName')]"
                        },
                        {
                          "name": "STORAGE_BLOB_ENDPOINT",
                          "value": "[parameters('storageBlobEndpoint')]"
                        },
                        {
                          "name": "AZURE_OPENAI_ENDPOINT",
                          "value": "[parameters('openAiEndpoint')]"
                        },
                        {
                          "name": "AZURE_OPENAI_CHAT_DEPLOYMENT_NAME",
                          "value": "[parameters('openAiChatDeploymentName')]"
                        },
                        {
                          "name": "AZURE_OPENAI_WHISPER_DEPLOYMENT_NAME",
                          "value": "[parameters('openAiWhisperDeploymentName')]"
                        },
                        {
                          "name": "SERVICE_BUS_NAMESPACE",
                          "value": "[format('{0}.servicebus.windows.net', parameters('serviceBusNamespace'))]"
                        },
                        {
                          "name": "SERVICE_BUS_QUEUE_NAME",
                          "value": "[parameters('serviceBusQueueName')]"
                        },
                        {
                          "name": "KEY_VAULT_NAME",
                          "value": "[parameters('keyVaultName')]"
                        },
                        {
                          "name": "AI_PROCESSING_MODE",
                          "value": "azure_openai"
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 0,
                    "maxReplicas": 10,
                    "rules": [
                      {
                        "name": "queue-scaling",
                        "custom": {
                          "type": "azure-servicebus",
                          "metadata": {
                            "queueName": "[parameters('serviceBusQueueName')]",
                            "namespace": "[parameters('serviceBusNamespace')]",
                            "messageCount": "5"
                          },
                          "auth": [
                            {
                              "secretRef": "service-bus-connection-string",
                              "triggerParameter": "connection"
                            }
                          ]
                        }
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName'))]"
              ],
              "metadata": {
                "description": "Worker Container App - Background audio processing"
              }
            }
          ],
          "outputs": {
            "containerAppsEnvId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment ID"
              },
              "value": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName'))]"
            },
            "containerAppsEnvDomain": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment default domain"
              },
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName')), '2024-03-01').defaultDomain]"
            },
            "apiAppUrl": {
              "type": "string",
              "metadata": {
                "description": "API Container App URL"
              },
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', variables('apiAppName')), '2024-03-01').configuration.ingress.fqdn)]"
            },
            "uiAppUrl": {
              "type": "string",
              "metadata": {
                "description": "UI Container App URL"
              },
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', variables('uiAppName')), '2024-03-01').configuration.ingress.fqdn)]"
            },
            "apiAppName": {
              "type": "string",
              "metadata": {
                "description": "API Container App name"
              },
              "value": "[variables('apiAppName')]"
            },
            "uiAppName": {
              "type": "string",
              "metadata": {
                "description": "UI Container App name"
              },
              "value": "[variables('uiAppName')]"
            },
            "workerAppName": {
              "type": "string",
              "metadata": {
                "description": "Worker Container App name"
              },
              "value": "[variables('workerAppName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ai-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'data-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'queues-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'security-deployment')]"
      ]
    },
    {
      "condition": "[parameters('enablePrivateEndpoints')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "privateendpoints-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "vnetName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetName.value]"
          },
          "privateEndpointsSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.privateEndpointsSubnetId.value]"
          },
          "storageAccountId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.storageAccountId.value]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "postgresServerId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.postgresServerId.value]"
          },
          "postgresServerName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.postgresServerName.value]"
          },
          "openAiId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'ai-deployment'), '2025-04-01').outputs.openAiId.value]"
          },
          "openAiName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'ai-deployment'), '2025-04-01').outputs.openAiAccountName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "18067739061769991880"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource naming prefix (reserved for future use)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Virtual Network ID to link DNS zones"
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Virtual Network name for DNS zone links"
              }
            },
            "privateEndpointsSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for private endpoints"
              }
            },
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage Account resource ID"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account name"
              }
            },
            "postgresServerId": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL Server resource ID"
              }
            },
            "postgresServerName": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL Server name"
              }
            },
            "openAiId": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI resource ID"
              }
            },
            "openAiName": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI name"
              }
            }
          },
          "variables": {
            "storageBlobDnsZoneName": "privatelink.blob.core.windows.net",
            "postgresDnsZoneName": "privatelink.postgres.database.azure.com",
            "openAiDnsZoneName": "privatelink.openai.azure.com"
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('storageBlobDnsZoneName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "metadata": {
                "description": "Private DNS Zone for Azure Blob Storage"
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('storageBlobDnsZoneName'), format('{0}-link', parameters('vnetName')))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('storageBlobDnsZoneName'))]"
              ],
              "metadata": {
                "description": "Link Storage Blob DNS Zone to VNet"
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('postgresDnsZoneName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "metadata": {
                "description": "Private DNS Zone for Azure PostgreSQL"
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('postgresDnsZoneName'), format('{0}-link', parameters('vnetName')))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('postgresDnsZoneName'))]"
              ],
              "metadata": {
                "description": "Link PostgreSQL DNS Zone to VNet"
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('openAiDnsZoneName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "metadata": {
                "description": "Private DNS Zone for Azure OpenAI"
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('openAiDnsZoneName'), format('{0}-link', parameters('vnetName')))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('openAiDnsZoneName'))]"
              ],
              "metadata": {
                "description": "Link Azure OpenAI DNS Zone to VNet"
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[format('pe-{0}-blob', parameters('storageAccountName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointsSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('pe-{0}-blob-connection', parameters('storageAccountName'))]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('storageAccountId')]",
                      "groupIds": [
                        "blob"
                      ]
                    }
                  }
                ]
              },
              "metadata": {
                "description": "Private Endpoint for Azure Blob Storage"
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', format('pe-{0}-blob', parameters('storageAccountName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-blob-core-windows-net",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('storageBlobDnsZoneName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('storageBlobDnsZoneName'))]",
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}-blob', parameters('storageAccountName')))]"
              ],
              "metadata": {
                "description": "DNS Zone Group for Storage Blob Private Endpoint"
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[format('pe-{0}', parameters('postgresServerName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointsSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('pe-{0}-connection', parameters('postgresServerName'))]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('postgresServerId')]",
                      "groupIds": [
                        "postgresqlServer"
                      ]
                    }
                  }
                ]
              },
              "metadata": {
                "description": "Private Endpoint for Azure PostgreSQL"
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', format('pe-{0}', parameters('postgresServerName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-postgres-database-azure-com",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('postgresDnsZoneName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('postgresDnsZoneName'))]",
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('postgresServerName')))]"
              ],
              "metadata": {
                "description": "DNS Zone Group for PostgreSQL Private Endpoint"
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[format('pe-{0}', parameters('openAiName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointsSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('pe-{0}-connection', parameters('openAiName'))]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('openAiId')]",
                      "groupIds": [
                        "account"
                      ]
                    }
                  }
                ]
              },
              "metadata": {
                "description": "Private Endpoint for Azure OpenAI"
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', format('pe-{0}', parameters('openAiName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-openai-azure-com",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('openAiDnsZoneName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('openAiDnsZoneName'))]",
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('openAiName')))]"
              ],
              "metadata": {
                "description": "DNS Zone Group for Azure OpenAI Private Endpoint"
              }
            }
          ],
          "outputs": {
            "storageBlobDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Storage Blob Private DNS Zone ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('storageBlobDnsZoneName'))]"
            },
            "postgresDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL Private DNS Zone ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('postgresDnsZoneName'))]"
            },
            "openAiDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI Private DNS Zone ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('openAiDnsZoneName'))]"
            },
            "storageBlobPrivateEndpointId": {
              "type": "string",
              "metadata": {
                "description": "Storage Blob Private Endpoint ID"
              },
              "value": "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}-blob', parameters('storageAccountName')))]"
            },
            "postgresPrivateEndpointId": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL Private Endpoint ID"
              },
              "value": "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('postgresServerName')))]"
            },
            "openAiPrivateEndpointId": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI Private Endpoint ID"
              },
              "value": "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('openAiName')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ai-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'containerapps-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'data-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "outputs-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "postgresHost": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.postgresHost.value]"
          },
          "postgresDatabaseName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.postgresDatabaseName.value]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "storageBlobEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.storageBlobEndpoint.value]"
          },
          "openAiEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'ai-deployment'), '2025-04-01').outputs.openAiEndpoint.value]"
          },
          "openAiChatDeploymentName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'ai-deployment'), '2025-04-01').outputs.chatDeploymentName.value]"
          },
          "openAiWhisperDeploymentName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'ai-deployment'), '2025-04-01').outputs.whisperDeploymentName.value]"
          },
          "serviceBusNamespace": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'queues-deployment'), '2025-04-01').outputs.serviceBusNamespace.value]"
          },
          "serviceBusQueueName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'queues-deployment'), '2025-04-01').outputs.queueName.value]"
          },
          "apiAppUrl": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerapps-deployment'), '2025-04-01').outputs.apiAppUrl.value]"
          },
          "uiAppUrl": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerapps-deployment'), '2025-04-01').outputs.uiAppUrl.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11255211477670717345"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              }
            },
            "postgresHost": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL host"
              }
            },
            "postgresDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL database name"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              }
            },
            "storageBlobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage blob endpoint"
              }
            },
            "openAiEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI endpoint"
              }
            },
            "openAiChatDeploymentName": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI chat deployment name"
              }
            },
            "openAiWhisperDeploymentName": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI Whisper deployment name"
              }
            },
            "serviceBusNamespace": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace name"
              }
            },
            "serviceBusQueueName": {
              "type": "string",
              "metadata": {
                "description": "Service Bus queue name"
              }
            },
            "apiAppUrl": {
              "type": "string",
              "metadata": {
                "description": "API application URL"
              }
            },
            "uiAppUrl": {
              "type": "string",
              "metadata": {
                "description": "UI application URL"
              }
            }
          },
          "variables": {
            "deploymentSummary": {
              "applications": {
                "uiUrl": "[parameters('uiAppUrl')]",
                "apiUrl": "[parameters('apiAppUrl')]"
              },
              "dataServices": {
                "postgres": {
                  "host": "[parameters('postgresHost')]",
                  "databaseName": "[parameters('postgresDatabaseName')]"
                },
                "storage": {
                  "accountName": "[parameters('storageAccountName')]",
                  "blobEndpoint": "[parameters('storageBlobEndpoint')]"
                }
              },
              "aiServices": {
                "openAi": {
                  "endpoint": "[parameters('openAiEndpoint')]",
                  "chatDeployment": "[parameters('openAiChatDeploymentName')]",
                  "whisperDeployment": "[parameters('openAiWhisperDeploymentName')]"
                }
              },
              "messaging": {
                "serviceBus": {
                  "namespace": "[parameters('serviceBusNamespace')]",
                  "queueName": "[parameters('serviceBusQueueName')]"
                }
              },
              "security": {
                "keyVaultName": "[parameters('keyVaultName')]"
              }
            }
          },
          "resources": [],
          "outputs": {
            "deploymentSummary": {
              "type": "object",
              "metadata": {
                "description": "Complete deployment summary"
              },
              "value": "[variables('deploymentSummary')]"
            },
            "uiUrl": {
              "type": "string",
              "metadata": {
                "description": "UI application URL"
              },
              "value": "[parameters('uiAppUrl')]"
            },
            "apiUrl": {
              "type": "string",
              "metadata": {
                "description": "API application URL"
              },
              "value": "[parameters('apiAppUrl')]"
            },
            "keyVault": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name for secrets management"
              },
              "value": "[parameters('keyVaultName')]"
            },
            "postgresHostOutput": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL host for data access"
              },
              "value": "[parameters('postgresHost')]"
            },
            "openAiServiceEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI endpoint for AI services"
              },
              "value": "[parameters('openAiEndpoint')]"
            },
            "serviceBus": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace for messaging"
              },
              "value": "[format('{0}.servicebus.windows.net', parameters('serviceBusNamespace'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ai-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'containerapps-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'data-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'queues-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'security-deployment')]"
      ]
    }
  ],
  "outputs": {
    "uiAppUrl": {
      "type": "string",
      "metadata": {
        "description": "URL of the UI application"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerapps-deployment'), '2025-04-01').outputs.uiAppUrl.value]"
    },
    "apiAppUrl": {
      "type": "string",
      "metadata": {
        "description": "URL of the API application"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerapps-deployment'), '2025-04-01').outputs.apiAppUrl.value]"
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Key Vault"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'security-deployment'), '2025-04-01').outputs.keyVaultName.value]"
    },
    "postgresHost": {
      "type": "string",
      "metadata": {
        "description": "PostgreSQL host"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'data-deployment'), '2025-04-01').outputs.postgresHost.value]"
    },
    "openAiEndpoint": {
      "type": "string",
      "metadata": {
        "description": "Azure OpenAI endpoint"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'ai-deployment'), '2025-04-01').outputs.openAiEndpoint.value]"
    }
  }
}